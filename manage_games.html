<!-- manage_games.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Games – Game Tracker</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ─────────────── Header Bar ─────────────── */
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background-color: rgb(36, 36, 36);     /* Elib.Colors.Header */
      border-radius: 4px;
    }
    .header-bar h1 {
      margin: 0;
      font-size: 1.5rem;
      color: rgb(240, 240, 240);
    }
    .header-buttons {
      display: flex;
      align-items: center;
    }
    .header-buttons > * + * {
      margin-left: 2rem;
    }
    .header-buttons button {
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      padding: 0.4rem 0.8rem;
      transition: opacity 0.2s ease;
    }
    .header-buttons button:hover {
      opacity: 0.85;
    }
    .btn-gray {
      background-color: rgb(120, 120, 120);  /* Elib.Colors.Disabled */
      color: rgb(240, 240, 240);
    }
    .btn-red {
      background-color: rgb(190, 65, 65);    /* Elib.Colors.Negative */
      color: rgb(240, 240, 240);
    }

    /* ─────────────── Manage Games Form ─────────────── */
    #manage-container {
      background-color: rgb(36, 36, 36);      /* Elib.Colors.Header */
      border: 1px solid rgb(56, 56, 56);      /* Elib.Colors.Scroller */
      border-radius: 4px;
      padding: 1rem;
    }
    #games-list {
      list-style: none;
      padding: 0;
      margin: 0 0 1rem 0;
    }
    #games-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgb(56, 56, 56);
    }
    #games-list li:last-child {
      border-bottom: none;
    }
    .remove-game-button {
      background-color: rgb(190, 65, 65);   /* Elib.Colors.Negative */
      color: rgb(240, 240, 240);
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .remove-game-button:hover {
      opacity: 0.85;
    }
    #add-game-option-form {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    #add-game-option-form input[type="text"] {
      flex: 1;
      background-color: rgb(36, 36, 36);    /* Elib.Colors.Header */
      color: rgb(240, 240, 240);
      border: 1px solid rgb(56, 56, 56);    /* Elib.Colors.Scroller */
      border-radius: 4px;
      padding: 0.4rem;
      font-size: 1rem;
    }
    #add-game-option-form button {
      background-color: rgb(70, 175, 70);   /* Elib.Colors.Positive */
      color: rgb(240, 240, 240);
      border: none;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
      transition: opacity 0.2s ease;
    }
    #add-game-option-form button:hover {
      opacity: 0.85;
    }
    .error {
      color: rgb(190, 65, 65);              /* Elib.Colors.Negative */
      margin-top: 0.5rem;
    }
  </style>
</head>
<body data-page="admin-manage">
  <!-- ─────────────── Header Bar ─────────────── -->
  <div class="header-bar">
    <h1>Manage Games</h1>
    <div class="header-buttons">
      <a href="admin.html"><button class="btn-gray">← Back to Admin</button></a>
      <button id="logout-button" class="btn-red">Log Out</button>
    </div>
  </div>

  <!-- ─────────────── Games List & Add Form ─────────────── -->
  <div id="manage-container">
    <ul id="games-list">
      <!-- JS will populate existing options here as: 
           <li>War Selection <button class="remove-game-button">Remove</button></li> 
      -->
    </ul>

    <form id="add-game-option-form">
      <input type="text" id="new-game-name" placeholder="New game name…" required />
      <button type="submit">Add</button>
    </form>
    <div id="manage-error" class="error"></div>
  </div>

  <script>
    // RI: We only need the PAT‐login functions and generic fetch/commit from scripts.js
    const LOCAL_STORAGE_TOKEN_KEY = "github_access_token";
    const GAME_OPTIONS_PATH = "gameOptions.json";
    const API_BASE_URL = `https://api.github.com/repos/EveHaddox/Games-Leaderboard`;

    function logout() {
      localStorage.removeItem(LOCAL_STORAGE_TOKEN_KEY);
      window.location.href = "index.html";
    }

    // Generic fetchJSON and commitJSON from scripts.js:
    async function fetchJSON(path) {
      const url = `https://raw.githubusercontent.com/EveHaddox/Games-Leaderboard/main/${path}?cachebust=${Date.now()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to fetch ${path}`);
      return await res.json();
    }

    async function getFileSHAandContent(path) {
      const endpoint = `${API_BASE_URL}/contents/${path}`;
      const accessToken = localStorage.getItem(LOCAL_STORAGE_TOKEN_KEY);
      const headers = { Accept: "application/vnd.github.v3+json" };
      if (accessToken) headers.Authorization = `Bearer ${accessToken}`;
      const res = await fetch(endpoint, { headers });
      if (res.status === 404) return { sha: null, content: btoa("[]") };
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(`GitHub API error (${path}): ${msg}`);
      }
      const data = await res.json();
      return { sha: data.sha, content: data.content };
    }

    async function commitJSON(newArray, path, commitMessage) {
      const accessToken = localStorage.getItem(LOCAL_STORAGE_TOKEN_KEY);
      if (!accessToken) throw new Error("No GitHub token found. Please login first.");
      const { sha, content: oldBase64 } = await getFileSHAandContent(path);
      const newContentString = JSON.stringify(newArray, null, 2);
      const newContentBase64 = btoa(unescape(encodeURIComponent(newContentString)));

      const endpoint = `${API_BASE_URL}/contents/${path}`;
      const body = {
        message: commitMessage,
        content: newContentBase64,
        ...(sha ? { sha } : {}),
        branch: "main"
      };
      const res = await fetch(endpoint, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          Accept: "application/vnd.github.v3+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`GitHub commit failed (${path}): ${errText}`);
      }
      return await res.json();
    }

    // Populate list of existing game options
    async function renderGameOptions() {
      const list = document.getElementById("games-list");
      list.innerHTML = "";
      let options;
      try {
        options = await fetchJSON(GAME_OPTIONS_PATH);
      } catch (err) {
        document.getElementById("manage-error").innerText = "Error loading options: " + err;
        return;
      }
      options.forEach((gameName, idx) => {
        const li = document.createElement("li");
        const span = document.createElement("span");
        span.innerText = gameName;
        li.appendChild(span);

        // Only allow removal if idx ≥ 0 (we want to allow removing any option)
        const btn = document.createElement("button");
        btn.className = "remove-game-button";
        btn.innerText = "Remove";
        btn.addEventListener("click", () => removeGameOption(idx));
        li.appendChild(btn);

        list.appendChild(li);
      });
    }

    // Add a new game option
    async function onAddGameOptionSubmit(event) {
      event.preventDefault();
      const input = document.getElementById("new-game-name");
      const newName = input.value.trim();
      if (!newName) return;

      try {
        const { sha, content: oldBase64 } = await getFileSHAandContent(GAME_OPTIONS_PATH);
        const oldArray = JSON.parse(atob(oldBase64));
        if (oldArray.includes(newName)) {
          document.getElementById("manage-error").innerText = "That game already exists.";
          return;
        }
        oldArray.push(newName);
        await commitJSON(oldArray, GAME_OPTIONS_PATH, `Add game option: ${newName}`);
        input.value = "";
        document.getElementById("manage-error").innerText = "";
        await renderGameOptions();
      } catch (err) {
        document.getElementById("manage-error").innerText = "Error adding game: " + err.message;
      }
    }

    // Remove a game option at index idx
    async function removeGameOption(idx) {
      try {
        const { sha, content: oldBase64 } = await getFileSHAandContent(GAME_OPTIONS_PATH);
        const oldArray = JSON.parse(atob(oldBase64));
        oldArray.splice(idx, 1);
        await commitJSON(oldArray, GAME_OPTIONS_PATH, `Remove game option at index ${idx}`);
        await renderGameOptions();
      } catch (err) {
        document.getElementById("manage-error").innerText = "Error removing game: " + err.message;
      }
    }

    // On page load:
    function initManageGamesPage() {
      // If no token, redirect to admin login
      if (!localStorage.getItem(LOCAL_STORAGE_TOKEN_KEY)) {
        window.location.href = "admin.html";
        return;
      }
      renderGameOptions();
      document.getElementById("logout-button").onclick = logout;
      document.getElementById("add-game-option-form").onsubmit = onAddGameOptionSubmit;
    }
    document.addEventListener("DOMContentLoaded", initManageGamesPage);
  </script>
</body>
</html>
