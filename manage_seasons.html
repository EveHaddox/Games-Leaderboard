<!-- manage_seasons.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€“ Manage Seasons</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Sidebar & Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: rgb(26, 26, 26); /* Elib.Background */
      color: rgb(240, 240, 240);
    }
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 220px;
      height: 100vh;
      background-color: rgb(36, 36, 36);    /* Elib.Header */
      border-right: 1px solid rgb(56, 56, 56); /* Elib.Scroller */
      display: flex;
      flex-direction: column;
      padding-top: 1rem;
    }
    .sidebar a {
      text-decoration: none;
    }
    .sidebar .nav-item {
      padding: 0.75rem 1rem;
      font-size: 1rem;
      color: rgb(200, 200, 200);             /* Elib.SecondaryText */
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }
    .sidebar .nav-item:hover {
      background-color: rgb(56, 56, 56);    /* Elib.Scroller */
      color: rgb(240, 240, 240);
    }
    .sidebar .nav-item.active {
      background-color: rgb(56, 56, 56);
      color: rgb(240, 240, 240);
      font-weight: bold;
    }
    .content {
      margin-left: 220px;
      padding: 1.5rem;
    }
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      background-color: rgb(36, 36, 36);     /* Elib.Header */
      border-radius: 4px;
    }
    .header-bar h1 {
      margin: 0;
      font-size: 1.5rem;
      color: rgb(240, 240, 240);
    }
    .header-buttons {
      display: flex;
      align-items: center;
    }
    .header-buttons > * + * {
      margin-left: 1rem;
    }
    .header-buttons button {
      font-size: 0.9rem;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      padding: 0.4rem 0.8rem;
      transition: opacity 0.2s ease;
    }
    .header-buttons button:hover {
      opacity: 0.85;
    }
    .btn-gray {
      background-color: rgb(120, 120, 120);  /* Elib.Disabled */
      color: rgb(240, 240, 240);
    }
    .btn-red {
      background-color: rgb(190, 65, 65);    /* Elib.Negative */
      color: rgb(240, 240, 240);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Current Season Selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #current-season-container {
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    #current-season-select {
      background-color: rgb(36, 36, 36);    /* Elib.Header */
      color: rgb(240, 240, 240);
      border: 1px solid rgb(56, 56, 56);    /* Elib.Scroller */
      border-radius: 4px;
      padding: 0.4rem;
      font-size: 1rem;
    }
    #set-current-button {
      background-color: rgb(70, 175, 70);   /* Elib.Positive */
      color: rgb(240, 240, 240);
      border: none;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
      transition: opacity 0.2s ease;
      width: 150px;
      text-align: center;
    }
    #set-current-button:hover {
      opacity: 0.85;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Seasons List & Add Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #manage-container {
      background-color: rgb(36, 36, 36);      /* Elib.Header */
      border: 1px solid rgb(56, 56, 56);      /* Elib.Scroller */
      border-radius: 4px;
      padding: 1rem;
    }
    #seasons-list {
      list-style: none;
      padding: 0;
      margin: 0 0 1rem 0;
    }
    #seasons-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgb(56, 56, 56);
    }
    #seasons-list li:last-child {
      border-bottom: none;
    }
    .remove-season-button {
      background-color: rgb(190, 65, 65);   /* Elib.Negative */
      color: rgb(240, 240, 240);
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .remove-season-button:hover {
      opacity: 0.85;
    }

    #add-season-form {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    #add-season-form input[type="text"] {
      flex: 1;
      background-color: rgb(36, 36, 36);    /* Elib.Header */
      color: rgb(240, 240, 240);
      border: 1px solid rgb(56, 56, 56);    /* Elib.Scroller */
      border-radius: 4px;
      padding: 0.4rem;
      font-size: 1rem;
    }
    #add-season-form button {
      background-color: rgb(70, 175, 70);   /* Elib.Positive */
      color: rgb(240, 240, 240);
      border: none;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
      transition: opacity 0.2s ease;
    }
    #add-season-form button:hover {
      opacity: 0.85;
    }
    .error {
      color: rgb(190, 65, 65);              /* Elib.Negative */
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="sidebar">
    <a href="dashboard.html">
      <div class="nav-item">ðŸ“Š Dashboard</div>
    </a>
    <a href="admin.html">
      <div class="nav-item">âž• Add Game</div>
    </a>
    <a href="manage_games.html">
      <div class="nav-item">ðŸŽ® Manage Games</div>
    </a>
    <a href="manage_seasons.html">
      <div class="nav-item active">ðŸ—“ Manage Seasons</div>
    </a>
    <a href="index.html">
      <div class="nav-item">ðŸ”™ Back to Leaderboard</div>
    </a>
    <button id="logout-button" class="nav-item" style="background:none; border:none; width:100%; text-align:left; color:rgb(200,200,200);">
      ðŸšª Log Out
    </button>
  </div>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="content">
    <div class="header-bar">
      <h1>Manage Seasons</h1>
    </div>

    <!-- Current Season Dropdown + Button -->
    <div id="current-season-container">
      <label for="current-season-select"><strong>Current Season:</strong></label>
      <select id="current-season-select">
        <!-- Populated by JS -->
      </select>
      <button id="set-current-button">Set Current</button>
    </div>

    <!-- Seasons List & Add Form -->
    <div id="manage-container">
      <ul id="seasons-list"></ul>

      <form id="add-season-form">
        <input type="text" id="new-season-name" placeholder="New season (e.g. 2024-2025)" required />
        <button type="submit">Add</button>
      </form>
      <div id="manage-error" class="error"></div>
    </div>
  </div>

  <script>
    const LOCAL_STORAGE_TOKEN_KEY = "github_access_token";
    const SEASONS_PATH = "seasons.json";
    const API_BASE_URL = `https://api.github.com/repos/EveHaddox/Games-Leaderboard`;

    function logout() {
      localStorage.removeItem(LOCAL_STORAGE_TOKEN_KEY);
      window.location.href = "index.html";
    }

    async function fetchJSON(path) {
      const url = `https://raw.githubusercontent.com/EveHaddox/Games-Leaderboard/main/${path}?cachebust=${Date.now()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to fetch ${path}`);
      return await res.json();
    }

    async function getFileSHAandContent(path) {
      const endpoint = `${API_BASE_URL}/contents/${path}`;
      const accessToken = localStorage.getItem(LOCAL_STORAGE_TOKEN_KEY);
      const headers = { Accept: "application/vnd.github.v3+json" };
      if (accessToken) headers.Authorization = `Bearer ${accessToken}`;
      const res = await fetch(endpoint, { headers });
      if (res.status === 404) {
        return { sha: null, content: btoa(JSON.stringify({ current: "", all: [] })) };
      }
      if (!res.ok) {
        const msg = await res.text();
        throw new Error(`GitHub API error (${path}): ${msg}`);
      }
      const data = await res.json();
      return { sha: data.sha, content: data.content };
    }

    async function commitJSON(newObj, path, commitMessage) {
      const accessToken = localStorage.getItem(LOCAL_STORAGE_TOKEN_KEY);
      if (!accessToken) throw new Error("No GitHub token found. Please login first.");
      const { sha, content: oldBase64 } = await getFileSHAandContent(path);
      const newContentString = JSON.stringify(newObj, null, 2);
      const newContentBase64 = btoa(unescape(encodeURIComponent(newContentString)));

      const endpoint = `${API_BASE_URL}/contents/${path}`;
      const body = {
        message: commitMessage,
        content: newContentBase64,
        ...(sha ? { sha } : {}),
        branch: "main"
      };
      const res = await fetch(endpoint, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${accessToken}`,
          Accept: "application/vnd.github.v3+json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`GitHub commit failed (${path}): ${errText}`);
      }
      return await res.json();
    }

    async function renderSeasonsUI() {
      const select = document.getElementById("current-season-select");
      const list = document.getElementById("seasons-list");

      select.innerHTML = "";
      list.innerHTML = "";

      let data;
      try {
        data = await fetchJSON(SEASONS_PATH);
      } catch (err) {
        document.getElementById("manage-error").innerText = "Error loading seasons: " + err;
        return;
      }
      const { current, all } = data;

      // Populate current-season <select>
      all.forEach((seasonName) => {
        const opt = document.createElement("option");
        opt.value = seasonName;
        opt.innerText = seasonName;
        if (seasonName === current) opt.selected = true;
        select.appendChild(opt);
      });

      // Populate the list below
      all.forEach((seasonName, idx) => {
        const li = document.createElement("li");
        const span = document.createElement("span");
        span.innerText = seasonName + (seasonName === current ? " (current)" : "");
        li.appendChild(span);

        const btn = document.createElement("button");
        btn.className = "remove-season-button";
        btn.innerText = "Remove";
        btn.addEventListener("click", () => removeSeason(idx));
        li.appendChild(btn);

        list.appendChild(li);
      });
    }

    async function onAddSeasonSubmit(event) {
      event.preventDefault();
      const input = document.getElementById("new-season-name");
      const newName = input.value.trim();
      if (!newName) return;

      try {
        const { sha, content: oldBase64 } = await getFileSHAandContent(SEASONS_PATH);
        const data = JSON.parse(atob(oldBase64));
        const { all } = data;

        if (all.includes(newName)) {
          document.getElementById("manage-error").innerText = "That season already exists.";
          return;
        }

        // New season becomes current
        const newAll = all.concat(newName);
        const newObj = { current: newName, all: newAll };

        await commitJSON(newObj, SEASONS_PATH, `Add and set current season: ${newName}`);
        input.value = "";
        document.getElementById("manage-error").innerText = "";
        await renderSeasonsUI();
      } catch (err) {
        document.getElementById("manage-error").innerText = "Error adding season: " + err.message;
      }
    }

    async function removeSeason(idx) {
      try {
        const { sha, content: oldBase64 } = await getFileSHAandContent(SEASONS_PATH);
        const data = JSON.parse(atob(oldBase64));
        const { current, all } = data;
        const newAll = all.slice();
        const removed = newAll.splice(idx, 1)[0];

        let newCurrent = current;
        if (removed === current) {
          newCurrent = newAll.length ? newAll[0] : "";
        }
        const newObj = { current: newCurrent, all: newAll };
        await commitJSON(newObj, SEASONS_PATH, `Remove season: ${removed}`);
        await renderSeasonsUI();
      } catch (err) {
        document.getElementById("manage-error").innerText = "Error removing season: " + err.message;
      }
    }

    async function onSetCurrentSubmit() {
      const select = document.getElementById("current-season-select");
      const newCurrent = select.value;
      try {
        const { sha, content: oldBase64 } = await getFileSHAandContent(SEASONS_PATH);
        const data = JSON.parse(atob(oldBase64));
        const { all } = data;
        const newObj = { current: newCurrent, all: all };
        await commitJSON(newObj, SEASONS_PATH, `Set current season: ${newCurrent}`);
        await renderSeasonsUI();
      } catch (err) {
        document.getElementById("manage-error").innerText = "Error setting current season: " + err.message;
      }
    }

    function initManageSeasonsPage() {
      if (!localStorage.getItem(LOCAL_STORAGE_TOKEN_KEY)) {
        window.location.href = "admin.html";
        return;
      }
      renderSeasonsUI();
      document.getElementById("logout-button").onclick = logout;
      document.getElementById("add-season-form").onsubmit = onAddSeasonSubmit;
      document.getElementById("set-current-button").onclick = onSetCurrentSubmit;
    }

    document.addEventListener("DOMContentLoaded", initManageSeasonsPage);
  </script>
</body>
</html>
